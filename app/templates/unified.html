<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Unified Plugins View</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:0;background:#0b0b0c;color:#eee}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #222}
    main{padding:16px;display:grid;grid-template-columns:280px 1fr;gap:16px}
    .panel{background:#121214;border:1px solid #222;border-radius:12px;padding:14px}
    .list{max-height:70vh;overflow:auto}
    .plug{padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid transparent}
    .plug:hover{background:#1a1a1d}
    .plug.active{border-color:#2a7;background:#0f1f18}
    textarea{width:100%;min-height:180px;background:#0e0e0f;color:#ddd;border:1px solid #333;border-radius:10px;padding:10px;font-family:ui-monospace,Consolas}
    pre{background:#0e0e0f;border:1px solid #333;border-radius:10px;padding:12px;overflow:auto}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid #333;background:#1a1a1d;color:#eee;cursor:pointer}
    .btn:hover{background:#222}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #333}
    .chip{display:inline-flex;align-items:center;padding:4px 10px;border:1px solid #333;border-radius:999px;background:#1a1a1d;cursor:pointer}
    .chip:hover{background:#222}
    .chipbar{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:#aaa}
    .small{font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    input[type="text"]{background:#0e0e0f;color:#eee;border:1px solid #333;border-radius:6px;padding:6px 8px}
    code{font-family:ui-monospace,Consolas}
    .mode-toggle{display:inline-flex;border:1px solid #333;border-radius:999px;overflow:hidden}
    .mode-toggle button{border:0;background:transparent;padding:6px 10px;color:#aaa;cursor:pointer}
    .mode-toggle button.active{background:#0f1f18;color:#dfe;border-right:1px solid #333;border-left:1px solid #333}
  </style>
</head>
<body>
<header>
  <h3 style="margin:0">Unified Plugins View</h3>
  <a class="btn" href="/plugins/ui">↩︎ Plugins UI</a>
  <span class="pill" id="selName" style="margin-left:auto">no provider</span>
</header>

<main>
  <section class="panel">
    <h4 style="margin-top:0">Providers</h4>
    <div id="list" class="list"></div>
  </section>

  <section class="panel">
    <!-- شريط presets والمهام مثل البطاقة الأصلية -->
    <div class="chipbar" id="chips">
      <!-- يمتلئ تلقائيًا: default / manifest / task chips -->
    </div>

    <!-- صف التحكم: Task + الأزرار -->
    <div class="row">
      <div class="muted small">Task</div>
      <input id="task" type="text" value="translate">
      <div class="mode-toggle" style="margin-left:8px">
        <button id="modeRaw"    onclick="setMode('raw')">Raw</button>
        <button id="modeUnified" onclick="setMode('unified')" class="active">Unified</button>
      </div>
      <button class="btn" id="btnFocus" onclick="focusTask()">Focus</button>
      <button class="btn" id="btnPretty" onclick="pretty()">Pretty</button>
      <button class="btn" id="btnReset" onclick="resetPayload()">Reset</button>
      <button class="btn" id="btnSend"  onclick="send()">Send</button>
      <span class="pill" id="modeBadge">Unified</span>
    </div>

    <div class="grid">
      <div>
        <div class="muted small">JSON Payload</div>
        <textarea id="payload">{}</textarea>
      </div>
      <div>
        <div class="row" style="margin-top:0">
          <div class="muted small">Response</div>
          <div style="margin-left:auto; display:flex; gap:8px">
            <button class="btn" onclick="copyResp()">Copy</button>
            <button class="btn" onclick="saveQA()">Save Q+A</button>
          </div>
        </div>
        <pre id="resp">-</pre>
      </div>
    </div>
  </section>
</main>

<script>
const $  = s => document.querySelector(s);
let providers = [];
let active = null;
let mode = 'unified'; // unified | raw

function fmt(x){ try{ return JSON.stringify(x, null, 2) } catch{ return String(x) } }
function setMode(m){
  mode = m;
  $('#modeRaw').classList.toggle('active', m==='raw');
  $('#modeUnified').classList.toggle('active', m==='unified');
  $('#modeBadge').textContent = (m==='raw') ? 'Raw' : 'Unified';
}

function focusTask(){ $('#task').focus(); }

async function loadProviders(){
  const r = await fetch("/plugins");
  const j = await r.json();
  providers = (j.plugins||[]).sort();
  const list = $("#list");
  list.innerHTML = "";
  providers.forEach(name=>{
    const el = document.createElement("div");
    el.className = "plug";
    el.textContent = name;
    el.onclick = ()=> selectProvider(name);
    list.appendChild(el);
  });
}

function buildDefaultPayload(name){
  // مثل البطاقة الافتراضية
  const taskGuess =
    (name.includes("translate") || name.includes("translator")) ? "translate" :
    (name==="bart" ? "summarize" :
    (name==="distilbert" ? "text-classify" :
    (name==="wordcount" ? "count" :
    (name==="whisper" ? "infer" : "infer"))));
  const base = { provider: name, task: taskGuess };
  if (taskGuess === "translate") {
    base.text = "مرحبا بالعالم";
    base.source_lang = "arabic";
    base.target_lang = "english";
    base.max_new_tokens = 64;
    base.num_beams = 1;
    base.do_sample = false;
  } else if (name === "bart") {
    base.text = "This is a test sentence for summarization.";
    base.max_length = 60;
    base.min_length = 20;
  } else if (name === "distilbert") {
    base.text = "This is a great day!";
  }
  return base;
}

async function selectProvider(name){
  active = name;
  $("#selName").textContent = name || "no provider";
  document.querySelectorAll(".plug").forEach(x=> x.classList.toggle("active", x.textContent===name));

  // حمّل chips: default / manifest / tasks
  await buildChips(name);

  const payload = buildDefaultPayload(name);
  $("#task").value = payload.task || "";
  $("#payload").value = fmt(payload);
  $("#resp").textContent = "-";
}

async function buildChips(name){
  const bar = $("#chips");
  bar.innerHTML = "";

  // default chip
  bar.appendChild(chip("default", async ()=>{
    const p = buildDefaultPayload(name);
    $("#task").value = p.task || "";
    $("#payload").value = fmt(p);
  }));

  // manifest chip
  bar.appendChild(chip("manifest", async ()=>{ await loadManifestPreset(name); }));

  // tasks chips (من manifest إن وجدت)
  try{
    const r = await fetch(`/plugins-data/${name}/manifest.json`);
    if (r.ok){
      const mf = await r.json();
      const tasks = Array.isArray(mf.tasks) ? mf.tasks : [];
      tasks.forEach(t=>{
        bar.appendChild(chip(t, ()=>{
          $("#task").value = t;
          try{
            const o = JSON.parse($("#payload").value||"{}");
            o.task = t;
            $("#payload").value = fmt(o);
          }catch{}
        }));
      });
    }
  }catch{}
}

function chip(label, onClick){
  const el = document.createElement("button");
  el.className = "chip";
  el.type = "button";
  el.textContent = label;
  el.onclick = onClick;
  return el;
}

async function loadManifestPreset(name){
  try{
    const r = await fetch(`/plugins-data/${name}/manifest.json`);
    if (!r.ok) throw 0;
    const mf = await r.json();
    const preset =
      (mf && (mf.default || mf.preset || mf.example || (mf.examples && mf.examples[0]))) || {};
    const merged = Object.assign({}, {provider:name, task: $("#task").value||preset.task||'infer'}, preset);
    $("#payload").value = fmt(merged);
  }catch(e){
    // لا يوجد preset
  }
}

function pretty(){
  try{ $("#payload").value = fmt(JSON.parse($("#payload").value)); }catch{}
}

function resetPayload(){
  if (!active) return;
  const p = buildDefaultPayload(active);
  $("#task").value = p.task || "";
  $("#payload").value = fmt(p);
  $("#resp").textContent = "-";
}

async function send(){
  if (!active) return;
  let obj;
  try{ obj = JSON.parse($("#payload").value || "{}"); }catch(e){
    $("#resp").textContent = fmt({status:"error", error:String(e)}); return;
  }
  obj.provider = obj.provider || active;
  obj.task = $("#task").value || obj.task || "infer";

  const endpoint = (mode === 'unified') ? "/api/unified-inference" : "/inference";
  try{
    const r = await fetch(endpoint, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(obj)
    });
    const j = await r.json();
    $("#resp").textContent = fmt(j);
  }catch(e){
    $("#resp").textContent = fmt({status:"error", error:String(e)});
  }
}

async function copyResp(){
  try{
    await navigator.clipboard.writeText($("#resp").textContent || "");
  }catch{}
}

function saveQA(){
  try{
    const req = JSON.parse($("#payload").value || "{}");
    const res = JSON.parse($("#resp").textContent || "{}");
    const blob = new Blob([fmt({mode, request:req, response:res, provider:active, ts:new Date().toISOString()})], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `qa-${active}-${mode}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(e){
    // ignore
  }
}

loadProviders();
</script>
</body>
</html>
