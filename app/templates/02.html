<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NeuroServe - Plugins Demo (Presets)</title>
  <style>
    :root { --card:#fff; --bg:#f6f7fb; --text:#1a1a1a; --muted:#69707d; --border:#e5e7eb; }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1200px;margin:2rem auto;padding:0 1rem}
    h1{margin:.2rem 0 1rem}
    p.muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
    label{display:block;margin:.4rem 0 .25rem;font-weight:600}
    input,textarea{width:100%;padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px;font:inherit}
    textarea{min-height:160px}
    button{padding:.55rem .9rem;border-radius:10px;border:1px solid var(--border);background:#0d6efd;color:#fff;cursor:pointer}
    button.ghost{background:#fff;color:#0d6efd;border-color:#cfe0ff}
    ul{margin:.5rem 0 0 1rem}
    pre{background:#0b0b0b;color:#b9ffb9;border-radius:12px;padding:1rem;overflow:auto}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .6rem;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:.9rem;cursor:pointer}
    .pill code{background:#f3f4f6;border:1px solid var(--border);border-radius:6px;padding:.1rem .3rem}
    .hint{font-size:.85rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <h1>Plugins Demo</h1>
    <p class="muted">Discover installed plugins and run tasks via <code>POST /inference</code>. Click a preset to auto-fill the form.</p>

    <div class="grid">
      <div class="card">
        <div class="row" style="margin-bottom:.5rem;">
          <button class="ghost" onclick="loadPlugins()">Reload</button>
        </div>
        <ul id="plugins"></ul>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Run a Task</h3>
        <div class="row" id="presetsRow"></div>
        <label>Provider</label>
        <input id="provider" placeholder="e.g., clip"/>
        <label>Task</label>
        <input id="task" placeholder="e.g., embed-text"/>
        <label>JSON Payload</label>
        <textarea id="payload">{}</textarea>
        <div class="row" style="margin-top:.6rem">
          <button onclick="runTask()">Send</button>
          <button class="ghost" onclick="formatJSON()">Format JSON</button>
          <span class="hint">Tip: You can paste JSON and click Format.</span>
        </div>
      </div>
    </div>

    <h3>Response</h3>
    <pre id="out">{}</pre>
  </div>

<script>
const PRESETS = {
  bart: [
    { name: "summarize (short)", task: "summarize", body: { text: "NeuroServe is a lightweight FastAPI server for GPU/CPU inference. It ships with plugins and a simple UI.", min_length: 30, max_length: 80 } }
  ],
  clip: [
    { name: "embed-text", task: "embed-text", body: { text: "A cat sitting on a chair" } },
    { name: "similarity-text", task: "similarity-text", body: { text_a: "a black dog running", text_b: "a brown dog sprinting" } }
  ],
  distilbert: [
    { name: "classify (pos)", task: "classify", body: { text: "I absolutely love this product. Works great!" } },
    { name: "classify (neg)", task: "classify", body: { text: "This was a terrible experience and I regret buying it." } }
  ],
  resnet18: [
    { name: "classify (url)", task: "classify", body: { image_url: "https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg" } }
  ],
  tinyllama: [
    { name: "generate", task: "generate", body: { prompt: "Write a short friendly greeting to Tamer.", max_new_tokens: 64, temperature: 0.7 } }
  ],
  translator: [
    { name: "ar→en", task: "translate", body: { text: "مرحبا كيف حالك؟", source: "ar", target: "en" } },
    { name: "en→de", task: "translate", body: { text: "This server is working perfectly.", source: "en", target: "de" } }
  ],
  translator_m2m: [
    { name: "en→de", task: "translate", body: { text: "This server is working perfectly.", source: "en", target: "de" } }
  ],
  whisper: [
    { name: "speech-to-text (url)", task: "speech-to-text", body: { audio_url: "file:///R:/samples/audio/hello.wav", language: "en" } }
  ]
};

function presetPill(provider, preset) {
  const span = document.createElement("span");
  span.className = "pill";
  span.innerHTML = `${provider} <code>${preset.task}</code>`;
  span.onclick = () => {
    document.getElementById("provider").value = provider;
    document.getElementById("task").value = preset.task;
    document.getElementById("payload").value = JSON.stringify(preset.body, null, 2);
  };
  return span;
}

async function loadPlugins() {
  const res = await fetch('/plugins');
  const data = await res.json();
  const ul = document.getElementById('plugins');
  const presetsRow = document.getElementById('presetsRow');
  ul.innerHTML = '';
  presetsRow.innerHTML = '';

  (data.plugins || []).forEach(p => {
    const li = document.createElement('li');
    li.textContent = p;
    li.style.cursor = 'pointer';
    li.onclick = () => document.getElementById('provider').value = p;
    ul.appendChild(li);

    // add preset pills if we have them
    if (PRESETS[p]) {
      PRESETS[p].forEach(pr => presetsRow.appendChild(presetPill(p, pr)));
    }
  });
}

async function runTask() {
  const provider = document.getElementById('provider').value.trim();
  const task = document.getElementById('task').value.trim();
  let body = {};
  try { body = JSON.parse(document.getElementById('payload').value || "{}"); }
  catch (e) { alert('Invalid JSON body'); return; }

  body.provider = provider || body.provider;
  body.task = task || body.task;

  const res = await fetch('/inference', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  document.getElementById('out').textContent = JSON.stringify(data, null, 2);
}

function formatJSON() {
  const ta = document.getElementById('payload');
  try {
    const obj = JSON.parse(ta.value || "{}");
    ta.value = JSON.stringify(obj, null, 2);
  } catch (_) { alert("Invalid JSON"); }
}

loadPlugins();
</script>
</body>
</html>