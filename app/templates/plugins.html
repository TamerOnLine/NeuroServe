<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Plugins Console</title>
  <style>
    :root { --bg:#f5f7fb; --card:#fff; --link:#0a66ff; --text:#111; }
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Arial,Tahoma,sans-serif;margin:2rem;background:var(--bg);color:var(--text)}
    h1{margin:0 0 1rem}
    .muted{opacity:.8}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem;align-items:start}
    .card{background:var(--card);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:1rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    button{padding:.5rem .8rem;border:0;border-radius:8px;background:var(--link);color:#fff;cursor:pointer}
    button.secondary{background:#e9eefb;color:#133087}
    button:hover{filter:brightness(.95)}
    textarea{width:100%;min-height:140px;padding:.55rem .6rem;border:1px solid #d9d9e3;border-radius:8px;font-family:ui-monospace,Consolas,monospace}
    pre{background:#0f172a;color:#e2e8f0;padding:.75rem;border-radius:10px;overflow:auto;max-height:260px}
    .badge{display:inline-block;background:#eef3ff;border:1px solid #cfe0ff;color:#133087;border-radius:9999px;padding:.1rem .5rem;font-size:.8rem;margin-right:.25rem}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="topbar">
    <h1>🧩 Plugins Console</h1>
    <div class="row">
      <button class="secondary" onclick="reloadProviders()">↻ Reload</button>
      <a href="/"><button class="secondary">← Home</button></a>
    </div>
  </div>
  <p class="muted">
    هذه الصفحة تجلب قائمة الـplugins من <code>/plugins</code>، وتقرأ
    <code>manifest.json</code> لكل Plugin من <code>/plugins-data/&lt;name&gt;/manifest.json</code>.
  </p>

  <div id="cards" class="grid"></div>

<script>
const fmt = (o) => JSON.stringify(o, null, 2);

// جلب قائمة المزودين من /plugins
async function fetchProviders(){
  const r = await fetch('/plugins', { cache: 'no-store' });
  const j = await r.json();
  return j.providers || [];
}

// جلب manifest لاسم مزود محدد
async function fetchManifest(name){
  try{
    const r = await fetch(`/plugins-data/${name}/manifest.json`, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }catch(e){
    // fallback بسيط إذا لا يوجد ملف manifest.json
    return { provider: name, task: "infer" };
  }
}

// خريطة اسم المزود → manifest (للReset)
const MANIFESTS = Object.create(null);

// بناء بطاقة واحدة
function cardHTML(p, manifest){
  const id = `prov_${p.name}`;
  const tasksHtml = (p.tasks || []).map(t => `<span class="badge">${t}</span>`).join('');
  return `
    <div class="card" id="${id}">
      <h3 style="margin:.2rem 0 .4rem">${p.title || p.name}</h3>
      <div style="margin:.3rem 0 .6rem">
        <span class="badge">${p.name}</span>
        ${tasksHtml}
      </div>
      <label>Request JSON</label>
      <textarea id="${id}_req">${fmt(manifest)}</textarea>
      <div class="row" style="margin:.6rem 0">
        <button onclick="send('${id}')">Send</button>
        <button class="secondary" onclick="resetToManifest('${id}','${p.name}')">Reset</button>
        <button class="secondary" onclick="pretty('${id}_req')">Pretty</button>
      </div>
      <label>Response</label>
      <pre id="${id}_res">—</pre>
    </div>
  `;
}

// pretty-print للـtextarea الحالي
function pretty(elId){
  const ta = document.getElementById(elId);
  try{ ta.value = fmt(JSON.parse(ta.value)); }catch(e){}
}

// إعادة النص لقيمة manifest الأصلية
function resetToManifest(cardId, name){
  const ta = document.getElementById(cardId + '_req');
  if (!ta) return;
  ta.value = fmt(MANIFESTS[name] || { provider: name, task: "infer" });
}

// إرسال الطلب إلى /inference
async function send(cardId){
  const ta = document.getElementById(cardId + '_req');
  const out = document.getElementById(cardId + '_res');
  out.textContent = "⏳ Sending…";
  try{
    const payload = JSON.parse(ta.value);
    const r = await fetch('/inference', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    out.textContent = fmt(data);
  }catch(e){
    out.textContent = String(e);
  }
}

// رندر الصفحة: اجلب جميع المانيفستات أولاً ثم ابنِ البطاقات
async function render(){
  const providers = await fetchProviders();
  const manifests = await Promise.all(providers.map(p => fetchManifest(p.name)));
  providers.forEach((p, i) => MANIFESTS[p.name] = manifests[i]);
  const html = providers.map((p, i) => cardHTML(p, manifests[i])).join('');
  document.getElementById('cards').innerHTML = html || '<p>لا يوجد Plugins.</p>';
}

// زر Reload
async function reloadProviders(){ await render(); }

// أول تحميل
render();
</script>
</body>
</html>
