<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Plugins Console</title>
  <style>
    :root { --bg:#f5f7fb; --card:#fff; --link:#0a66ff; --text:#111; }
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Arial,Tahoma,sans-serif;margin:2rem;background:var(--bg);color:var(--text)}
    h1{margin:0 0 1rem}
    .muted{opacity:.8}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem;align-items:start}
    .card{background:var(--card);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:1rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    button{padding:.5rem .8rem;border:0;border-radius:8px;background:var(--link);color:#fff;cursor:pointer}
    button.secondary{background:#e9eefb;color:#133087}
    button:hover{filter:brightness(.95)}
    textarea{width:100%;min-height:140px;padding:.55rem .6rem;border:1px solid #d9d9e3;border-radius:8px;font-family:ui-monospace,Consolas,monospace}
    pre{background:#0f172a;color:#e2e8f0;padding:.75rem;border-radius:10px;overflow:auto;max-height:260px}
    .badge{display:inline-block;background:#eef3ff;border:1px solid #cfe0ff;color:#133087;border-radius:9999px;padding:.1rem .5rem;font-size:.8rem;margin-right:.25rem}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="topbar">
    <h1>ğŸ§© Plugins Console</h1>
    <div class="row">
      <button class="secondary" onclick="reloadProviders()">â†» Reload</button>
      <a href="/"><button class="secondary">â† Home</button></a>
    </div>
  </div>
  <p class="muted">
    Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€plugins Ù…Ù† <code>/plugins</code>ØŒ ÙˆØªÙ‚Ø±Ø£
    <code>manifest.json</code> Ù„ÙƒÙ„ Plugin Ù…Ù† <code>/plugins-data/&lt;name&gt;/manifest.json</code>.
  </p>

  <div id="cards" class="grid"></div>

<script>
const fmt = (o) => JSON.stringify(o, null, 2);

// Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† Ù…Ù† /plugins
async function fetchProviders(){
  const r = await fetch('/plugins', { cache: 'no-store' });
  const j = await r.json();
  return j.providers || [];
}

// Ø¬Ù„Ø¨ manifest Ù„Ø§Ø³Ù… Ù…Ø²ÙˆØ¯ Ù…Ø­Ø¯Ø¯
async function fetchManifest(name){
  try{
    const r = await fetch(`/plugins-data/${name}/manifest.json`, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }catch(e){
    // fallback Ø¨Ø³ÙŠØ· Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù manifest.json
    return { provider: name, task: "infer" };
  }
}

// Ø®Ø±ÙŠØ·Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø²ÙˆØ¯ â†’ manifest (Ù„Ù„Reset)
const MANIFESTS = Object.create(null);

// Ø¨Ù†Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø©
function cardHTML(p, manifest){
  const id = `prov_${p.name}`;
  const tasksHtml = (p.tasks || []).map(t => `<span class="badge">${t}</span>`).join('');
  return `
    <div class="card" id="${id}">
      <h3 style="margin:.2rem 0 .4rem">${p.title || p.name}</h3>
      <div style="margin:.3rem 0 .6rem">
        <span class="badge">${p.name}</span>
        ${tasksHtml}
      </div>
      <label>Request JSON</label>
      <textarea id="${id}_req">${fmt(manifest)}</textarea>
      <div class="row" style="margin:.6rem 0">
        <button onclick="send('${id}')">Send</button>
        <button class="secondary" onclick="resetToManifest('${id}','${p.name}')">Reset</button>
        <button class="secondary" onclick="pretty('${id}_req')">Pretty</button>
      </div>
      <label>Response</label>
      <pre id="${id}_res">â€”</pre>
    </div>
  `;
}

// pretty-print Ù„Ù„Ù€textarea Ø§Ù„Ø­Ø§Ù„ÙŠ
function pretty(elId){
  const ta = document.getElementById(elId);
  try{ ta.value = fmt(JSON.parse(ta.value)); }catch(e){}
}

// Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ù„Ù‚ÙŠÙ…Ø© manifest Ø§Ù„Ø£ØµÙ„ÙŠØ©
function resetToManifest(cardId, name){
  const ta = document.getElementById(cardId + '_req');
  if (!ta) return;
  ta.value = fmt(MANIFESTS[name] || { provider: name, task: "infer" });
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ /inference
async function send(cardId){
  const ta = document.getElementById(cardId + '_req');
  const out = document.getElementById(cardId + '_res');
  out.textContent = "â³ Sendingâ€¦";
  try{
    const payload = JSON.parse(ta.value);
    const r = await fetch('/inference', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    out.textContent = fmt(data);
  }catch(e){
    out.textContent = String(e);
  }
}

// Ø±Ù†Ø¯Ø± Ø§Ù„ØµÙØ­Ø©: Ø§Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³ØªØ§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø¨Ù†Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
async function render(){
  const providers = await fetchProviders();
  const manifests = await Promise.all(providers.map(p => fetchManifest(p.name)));
  providers.forEach((p, i) => MANIFESTS[p.name] = manifests[i]);
  const html = providers.map((p, i) => cardHTML(p, manifests[i])).join('');
  document.getElementById('cards').innerHTML = html || '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Plugins.</p>';
}

// Ø²Ø± Reload
async function reloadProviders(){ await render(); }

// Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
render();
</script>
</body>
</html>
