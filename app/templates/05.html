<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NeuroServe — Pro Plugins UI (v2)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
      --brand:#0d6efd; --brand-ghost:#e9f2ff; --chip:#eef3ff; --chip-bd:#cfe0ff; --chip-tx:#133087;
      --code-bg:#0b0f1a; --code-tx:#c7ffbf;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    .layout{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .side{
      background:#ffffffcc; backdrop-filter: blur(6px);
      border-right:1px solid var(--border);
      padding:1rem; position:sticky; top:0; height:100vh; overflow:auto;
    }
    .brand{display:flex;align-items:center;gap:.6rem;margin-bottom:.75rem}
    .brand h1{font-size:1.15rem;margin:0}
    .muted{color:var(--muted);font-size:.9rem}
    .search{display:flex;gap:.5rem;align-items:center;margin:.6rem 0}
    .search input{width:100%;padding:.55rem .7rem;border:1px solid var(--border);border-radius:10px;font:inherit}
    .plist{list-style:none;margin:.5rem 0 0;padding:0;display:flex;flex-direction:column;gap:.25rem}
    .plist li{
      display:flex;align-items:center;gap:.5rem;
      padding:.45rem .6rem;border-radius:10px;border:1px solid transparent;cursor:pointer;
    }
    .plist li:hover{background:#f3f6ff}
    .plist li.active{background:#eef3ff;border-color:var(--chip-bd)}
    .tag{margin-left:auto;font-size:.75rem;color:var(--muted)}
    .main{padding:1rem 1.25rem}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:1rem}
    .topbar .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    button{padding:.55rem .9rem;border-radius:10px;border:1px solid var(--border);background:var(--brand);color:#fff;cursor:pointer}
    button.ghost{background:#fff;color:var(--brand);border-color:#cfe0ff}
    button.secondary{background:#e9eefb;color:#123;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:1rem;align-items:start}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
    .card h3{margin:.2rem 0 .4rem}
    .badges{display:flex;flex-wrap:wrap;gap:.25rem;margin:.35rem 0 .5rem}
    .badge{display:inline-block;background:var(--chip);border:1px solid var(--chip-bd);color:var(--chip-tx);border-radius:999px;padding:.12rem .5rem;font-size:.8rem}
    label{display:block;margin:.45rem 0 .25rem;font-weight:600}
    textarea{width:100%;min-height:140px;padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px;font-family:ui-monospace,Consolas,monospace}
    pre{background:var(--code-bg);color:var(--code-tx);padding:1rem;border-radius:12px;overflow:auto;max-height:280px}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .pills{display:flex;gap:.4rem;flex-wrap:wrap;margin:.25rem 0 .5rem}
    .pill{display:inline-flex;align-items:center;gap:.45rem;padding:.35rem .6rem;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:.9rem;cursor:pointer}
    .pill code{background:#f3f4f6;border:1px solid var(--border);border-radius:6px;padding:.1rem .3rem}
    .hint{font-size:.85rem;color:var(--muted)}
    .footer{margin-top:1rem;color:var(--muted);font-size:.85rem;text-align:center}
    @media (max-width: 900px){
      .layout{grid-template-columns:1fr}
      .side{position:relative;height:auto}
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="side">
      <div class="brand">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 2l3 7h7l-5.5 4 2 7-6.5-4.5L5.5 20l2-7L2 9h7l3-7z" stroke="#0d6efd" fill="none"/></svg>
        <h1>NeuroServe — Pro UI</h1>
      </div>
      <div class="muted">واجهة موحّدة مع زر رجوع للأساس (manifest) لكل بطاقة.</div>
      <div class="search">
        <input id="search" placeholder="ابحث عن Plugin..." oninput="filterList()"/>
        <button class="ghost" onclick="refreshAll()">↻ Reload</button>
      </div>
      <ul id="plist" class="plist"></ul>
      <div class="footer">Built for Tamer ⚡</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h2 style="margin:.2rem 0">Plugins</h2>
          <div class="muted">بطاقات + قائمة جانبية + Presets + زر Default لإرجاع المهمة والـJSON.</div>
        </div>
        <div class="row">
          <button class="ghost" onclick="formatAllJSON()">Format all JSON</button>
          <button class="secondary" onclick="collapseAll()">Collapse all</button>
          <button onclick="expandAll()">Expand all</button>
        </div>
      </div>
      <div id="cards" class="grid"></div>
    </main>
  </div>

<script>
const fmt = (o) => JSON.stringify(o, null, 2);

/** ---- Presets ---- */
const PRESETS = {
  bart: [
    { name: "summarize (short)", task: "summarize", body: { text: "NeuroServe is a lightweight FastAPI server for GPU/CPU inference. It ships with plugins and a simple UI.", min_length: 30, max_length: 80 } }
  ],
  clip: [
    { name: "embed-text", task: "embed-text", body: { text: "A cat sitting on a chair" } },
    { name: "similarity-text", task: "similarity-text", body: { text_a: "a black dog running", text_b: "a brown dog sprinting" } }
  ],
  distilbert: [
    { name: "classify (pos)", task: "classify", body: { text: "I absolutely love this product. Works great!" } },
    { name: "classify (neg)", task: "classify", body: { text: "This was a terrible experience and I regret buying it." } }
  ],
  resnet18: [
    { name: "classify (url)", task: "classify", body: { image_url: "https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg" } }
  ],
  tinyllama: [
    { name: "generate", task: "generate", body: { prompt: "Write a short friendly greeting to Tamer.", max_new_tokens: 64, temperature: 0.7 } }
  ],
  translator: [
    { name: "ar→en", task: "translate", body: { text: "مرحبا كيف حالك؟", source: "ar", target: "en" } },
    { name: "en→de", task: "translate", body: { text: "This server is working perfectly.", source: "en", target: "de" } }
  ],
  translator_m2m: [
    { name: "en→de", task: "translate", body: { text: "This server is working perfectly.", source: "en", target: "de" } }
  ],
  whisper: [
    { name: "speech-to-text (url)", task: "speech-to-text", body: { audio_url: "file:///R:/samples/audio/hello.wav", language: "en" } }
  ]
};

// Caches
const MANIFESTS = Object.create(null);      // name -> manifest JSON
let PROVIDERS = [];                          // [{name,title,tasks}, ...]

function pill(provider, preset){
  const span = document.createElement('span');
  span.className = 'pill';
  span.innerHTML = `${provider} <code>${preset.task}</code>`;
  span.title = preset.name;
  span.onclick = () => {
    const ta = document.getElementById(`prov_${provider}_req`);
    const tk = document.getElementById(`prov_${provider}_task`);
    if (tk) tk.value = preset.task;
    if (ta) ta.value = fmt(preset.body || {});
  };
  return span;
}

function defaultPill(provider){
  const span = document.createElement('span');
  span.className = 'pill';
  span.style.borderColor = '#bcd2ff';
  span.title = 'عودة للأساس (manifest)';
  span.innerHTML = `default <code>manifest</code>`;
  span.onclick = () => resetToManifest(provider, /*focus*/true);
  return span;
}

// Build one card
function cardHTML(p, manifest){
  const id = `prov_${p.name}`;
  const tasksHtml = (p.tasks || []).map(t => `<span class="badge">${t}</span>`).join('');

  // initial task: manifest.task -> first task -> '' 
  const initialTask = manifest.task || (Array.isArray(p.tasks) && p.tasks[0]) || '';

  return `
  <div class="card" id="${id}">
    <h3>${p.title || p.name}</h3>
    <div class="badges">
      <span class="badge">${p.name}</span>
      ${tasksHtml}
    </div>

    <div class="pills" id="${id}_pills"></div>

    <div class="row">
      <div style="flex:1">
        <label>Task</label>
        <input id="${id}_task" placeholder="e.g., embed-text" value="${initialTask}" />
      </div>
      <div>
        <label style="visibility:hidden">.</label>
        <button class="ghost" onclick="scrollToCard('${id}')">Focus</button>
      </div>
    </div>

    <label>JSON Payload</label>
    <textarea id="${id}_req">${fmt(manifest)}</textarea>
    <div class="row" style="margin:.6rem 0">
      <button onclick="send('${p.name}')">Send</button>
      <button class="ghost" onclick="resetToManifest('${p.name}',true)">Reset</button>
      <button class="secondary" onclick="pretty('${id}_req')">Pretty</button>
      <span class="hint">Tip: اختر Preset ثم عدّل JSON إذا لزم.</span>
    </div>

    <label>Response</label>
    <pre id="${id}_res">—</pre>
  </div>`;
}

function pretty(elId){
  const ta = document.getElementById(elId);
  try {
    const obj = JSON.parse(ta.value);
    ta.value = JSON.stringify(obj, null, 2);
  } catch(e) {
    alert("⚠️ JSON غير صالح:\n" + e.message);
  }
}


function formatAllJSON(){
  (PROVIDERS || []).forEach(p => {
    const ta = document.getElementById(`prov_${p.name}_req`);
    if (!ta) return;
    try{ ta.value = fmt(JSON.parse(ta.value)); }catch(_) {}
  });
}

function collapseAll(){
  (PROVIDERS || []).forEach(p => {
    const res = document.getElementById(`prov_${p.name}_res`);
    if (res) res.style.maxHeight = '80px';
  });
}
function expandAll(){
  (PROVIDERS || []).forEach(p => {
    const res = document.getElementById(`prov_${p.name}_res`);
    if (res) res.style.maxHeight = '280px';
  });
}

function scrollToCard(id){
  document.getElementById(id)?.scrollIntoView({ behavior:'smooth', block:'start' });
}

function filterList(){
  const q = document.getElementById('search').value.toLowerCase();
  const ul = document.getElementById('plist');
  ul.querySelectorAll('li').forEach(li => {
    const show = li.dataset.name.toLowerCase().includes(q);
    li.style.display = show ? '' : 'none';
  });
}

// Fetch providers list from /plugins
async function fetchProviders(){
  const r = await fetch('/plugins', { cache:'no-store' });
  const j = await r.json();
  if (Array.isArray(j.providers)) return j.providers;
  if (Array.isArray(j.plugins))   return j.plugins.map(n => ({ name:n, tasks:[], title:n }));
  return [];
}

// Fetch manifest for a given name
async function fetchManifest(name){
  try{
    const r = await fetch(`/plugins-data/${name}/manifest.json`, { cache:'no-store' });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }catch(e){
    return { provider:name, task:"infer" };
  }
}

async function render(){
  PROVIDERS = await fetchProviders();
  PROVIDERS = PROVIDERS.map(p => ({
    name: p.name || p.provider || p,
    tasks: p.tasks || [],
    title: p.title || p.name || p
  }));

  // Sidebar list
  const ul = document.getElementById('plist');
  ul.innerHTML = '';
  PROVIDERS.forEach(p => {
    const li = document.createElement('li');
    li.dataset.name = p.name;
    li.innerHTML = `<strong>${p.title || p.name}</strong><span class="tag">${p.name}</span>`;
    li.onclick = () => {
      document.querySelectorAll('.plist li').forEach(x => x.classList.remove('active'));
      li.classList.add('active');
      scrollToCard(`prov_${p.name}`);
      localStorage.setItem('last_provider', p.name);
    };
    ul.appendChild(li);
  });

  // Manifests + cards
  const manifests = await Promise.all(PROVIDERS.map(p => fetchManifest(p.name)));
  PROVIDERS.forEach((p, i) => MANIFESTS[p.name] = manifests[i]);
  const cardsHTML = PROVIDERS.map((p, i) => cardHTML(p, manifests[i])).join('');
  document.getElementById('cards').innerHTML = cardsHTML || '<p>لا يوجد Plugins.</p>';

  // Attach presets pills where available + Default pill
  PROVIDERS.forEach(p => {
    const wrap = document.getElementById(`prov_${p.name}_pills`);
    if (!wrap) return;
    wrap.appendChild(defaultPill(p.name)); // Always add Default
    if (PRESETS[p.name]) {
      PRESETS[p.name].forEach(pr => wrap.appendChild(pill(p.name, pr)));
    }
  });

  // restore last active
  const last = localStorage.getItem('last_provider');
  if (last) {
    document.querySelectorAll('.plist li').forEach(li => {
      if (li.dataset.name === last) li.classList.add('active');
    });
    scrollToCard(`prov_${last}`);
  }
}

async function refreshAll(){ await render(); }

function resetToManifest(name, focus=false){
  const manifest = MANIFESTS[name] || { provider:name, task:'infer' };
  const id = `prov_${name}`;
  const ta = document.getElementById(`${id}_req`);
  const tk = document.getElementById(`${id}_task`);

  if (ta) ta.value = fmt(manifest);
  if (tk) tk.value = manifest.task || 
       (Array.isArray((PROVIDERS.find(p=>p.name===name)||{}).tasks) 
         && (PROVIDERS.find(p=>p.name===name)||{}).tasks[0]) 
       || '';

  if (focus) scrollToCard(id);
}


async function send(name){
  const id = `prov_${name}`;
  const ta = document.getElementById(`${id}_req`);
  const out = document.getElementById(`${id}_res`);
  const taskEl = document.getElementById(`${id}_task`);
  out.textContent = "⏳ Sending…";

  let payload = {};
  try { payload = JSON.parse(ta.value || "{}"); }
  catch(e) { out.textContent = "Invalid JSON"; return; }

  payload.provider = name || payload.provider;
  if (taskEl && taskEl.value) payload.task = taskEl.value;

  try{
    const r = await fetch('/inference', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    out.textContent = fmt(data);
  }catch(e){
    out.textContent = String(e);
  }
}

render();
</script>
</body>
</html>
